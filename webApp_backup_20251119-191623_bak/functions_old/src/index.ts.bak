// ======= DEBUG: per-slot diagnostics (self-contained) =======
import { onRequest as _onRequest } from "firebase-functions/v2/https";
import admin from "firebase-admin";
export { debugBooth } from "./debugBooth";


export const debugBooth = _onRequest({ region: "europe-west1", cors: false }, async (req, res): Promise<void> => {
  // --- CORS (allow Hosting + localhost) ---
  const ALLOWED = new Set<string>([
    "https://ridercms-ced94.web.app",
    "https://ridercms-ced94.firebaseapp.com",
    "http://localhost:5000",
    "http://127.0.0.1:5000",
  ]);
  const origin = String(req.headers.origin || "");
  if (ALLOWED.has(origin)) {
    res.setHeader("Access-Control-Allow-Origin", origin);
    res.setHeader("Vary", "Origin");
  } else {
    res.setHeader("Access-Control-Allow-Origin", "*");
  }
  res.setHeader("Access-Control-Allow-Methods", "OPTIONS, POST");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");
  res.setHeader("Access-Control-Max-Age", "86400");
  if (req.method === "OPTIONS") { res.status(204).send(""); return; }
  if (req.method !== "POST")   { res.status(405).json({ error: "Method Not Allowed" }); return; }

  // --- Auth (verify Firebase ID token) ---
  async function requireAuth() {
    const h: string = req.headers.authorization || "";
    if (!h.startsWith("Bearer ")) throw new Error("Missing bearer token");
    const token = h.slice("Bearer ".length);
    try { return await admin.auth().verifyIdToken(token); }
    catch { throw new Error("Invalid or expired token"); }
  }
  try { await requireAuth(); } catch (e:any) { res.status(401).json({ error: e?.message || String(e) }); return; }

  // --- Input ---
  const boothRaw = req.body?.booth;
  const booth = typeof boothRaw === "string"
    ? boothRaw.trim().replace(/^[?&\s]*booth\s*=\s*/i, "").replace(/[^a-z0-9_-]+$/i, "")
    : "";
  if (!booth) { res.status(400).json({ error: "Missing booth" }); return; }

  // --- DB reads ---
  const db = admin.database();
  const [slotsSnap, sessSnap, resvSnap, telSnap] = await Promise.all([
    db.ref(`/booths/${booth}/slots`).get(),
    db.ref(`/sessionsBySlot/${booth}`).get(),
    db.ref(`/slotReservations/${booth}`).get(),
    db.ref(`/deviceTelemetry/${booth}`).get(),
  ]);
  const slots = (slotsSnap.val() || {}) as Record<string, any>;
  const sessions = (sessSnap.val() || {}) as Record<string, any>;
  const reservations = (resvSnap.val() || {}) as Record<string, any>;
  const telRaw = (telSnap.val() || {}) as Record<string, any>;

  // --- Normalize telemetry (ts + booleans) ---
  const toBool = (v:any)=> typeof v==="boolean" ? v
    : typeof v==="number" ? v!==0
    : typeof v==="string" ? ["true","yes","on","1","locked","closed"].includes(v.toLowerCase().trim())
      ? true : ["false","no","off","0","open","unlocked"].includes(v.toLowerCase().trim()) ? false : undefined
    : undefined;
  const normTs = (x:any)=> {
    if (typeof x==="number") return x < 10_000_000_000 ? x*1000 : x;
    if (typeof x==="string") {
      const n = Date.parse(x); if (!Number.isNaN(n)) return n;
      const num = Number(x); if (!Number.isNaN(num)) return num < 10_000_000_000 ? num*1000 : num;
    }
    return undefined;
  };
  function normalize(raw:any){
    if (!raw || typeof raw!=="object") return undefined as any;
    const ts = normTs(raw.ts) ?? normTs(raw.timestamp) ?? normTs(raw.updatedAt) ?? normTs(raw.time);
    const doorClosed =
      toBool(raw.doorClosed) ??
      (raw.doorState ? raw.doorState==="closed" : undefined) ??
      (typeof raw.door==="string" ? raw.door==="closed" : undefined) ??
      (typeof raw.doorOpen!=="undefined" ? !toBool(raw.doorOpen)! : undefined) ??
      toBool(raw.door_closed);
    const doorLocked =
      toBool(raw.doorLocked) ?? toBool(raw.locked) ??
      (typeof raw.lockState==="string" ? raw.lockState==="locked" : undefined) ??
      toBool(raw.lockEngaged);
    const relayOn = toBool(raw.relayOn) ?? toBool(raw.charging) ?? toBool(raw.chargeRelay) ?? toBool(raw.relay);
    const batteryInserted = toBool(raw.batteryInserted) ?? toBool(raw.batteryPresent) ?? toBool(raw.battery) ?? toBool(raw.hasBattery) ?? toBool(raw.packPresent);
    const isBusy = toBool(raw.isBusy) ?? toBool(raw.busy) ?? toBool(raw.occupied);
    const disabled = toBool(raw.disabled) ?? toBool(raw.outOfService) ?? toBool(raw.oos);
    return { ts, doorClosed, doorLocked, relayOn, batteryInserted, isBusy, disabled };
  }
  const tel: Record<string, any> = {};
  Object.keys(telRaw).forEach(k => tel[k] = normalize(telRaw[k]));

  // --- Slot keys (prefer config, else telemetry) ---
  const slotKeys = Object.keys(Object.keys(slots).length ? slots : tel).sort();
  if (!slotKeys.length) { res.status(404).json({ error: "Booth not found or has no slots", booth }); return; }

  // --- Evaluate STRICT and RELAXED policies ---
  const now = Date.now();
  function evalSlot(s:string, strict:boolean){
    const reasons:string[] = [];
    const t = tel[s] || {};
    if (sessions[s] && (sessions[s].sessionId || sessions[s].id)) reasons.push("active-session");
    if (reservations[s]) reasons.push("reserved");
    const ageOk = t.ts && (now - t.ts) >= 0 && (now - t.ts) <= (2*60*1000); // 2 min
    if (strict) {
      if (!t.ts) reasons.push("no-telemetry");
      else if (!ageOk) reasons.push("stale-telemetry");
      if (t.doorLocked !== true) reasons.push("door-unlocked");
    }
    if (t.disabled) reasons.push("disabled");
    if (t.relayOn) reasons.push("relay-on");
    if (t.batteryInserted) reasons.push("battery-inserted");
    if (t.isBusy) reasons.push("busy");
    if (t.doorClosed !== true) reasons.push("door-open");
    return { free: reasons.length === 0, reasons, ts: t.ts || null };
  }
  const strict: Record<string, any> = {};
  const relaxed: Record<string, any> = {};
  for (const s of slotKeys) {
    strict[s] = evalSlot(s, true);
    relaxed[s] = evalSlot(s, false);
  }

  res.status(200).json({
    booth, slotKeys, strict, relaxed,
    telemetryTs: Object.fromEntries(slotKeys.map(s => [s, tel[s]?.ts ?? null])),
  });
});
