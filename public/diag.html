<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>RiderCMS Diagnostics</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="assets/css/app.css" />
</head>
<body class="wrap">
  <div class="card"><h1>Diagnostics</h1><pre id="out">Running…</pre></div>
  <script type="module">
    const out = (m) => document.getElementById('out').textContent += (typeof m === 'string' ? m : JSON.stringify(m,null,2)) + "\n";
    try {
      out("Importing Firebase…");
      const { auth, db } = await import("./assets/js/firebase-init.js");
      const { onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js");
      const { ref, get, child } = await import("https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js");

      onAuthStateChanged(auth, async (user) => {
        out({ user: user ? { uid:user.uid, email:user.email } : null });

        if (!user) {
          out("Not signed in. Go to login.html first, then return here.");
          return;
        }

        // Check operator role
        try {
          const snap = await get(child(ref(db), `roles/operators/${user.uid}`));
          out({ operatorRole: snap.exists() ? snap.val() : false });
        } catch (e) { out({ operatorRoleError: String(e) }); }

        // Try a harmless read under your booth/slot
        const booth = "booth001", slot = "slot001";
        try {
          const ack = await get(ref(db, `deviceAcks/${booth}/${slot}`));
          out({ deviceAcks_path: `deviceAcks/${booth}/${slot}`, exists: ack.exists() });
        } catch (e) { out({ ackReadError: String(e) }); }
      });
    } catch (e) {
      out({ importError: String(e) });
    }
  </script>
</body>
</html>
